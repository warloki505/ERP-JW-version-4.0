<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ERP Financeiro - Perfil Financeiro v3.1</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="topbar">
    <div class="container topbar__row">
      <h1>üí∞ Gestor Financeiro</h1>
      <div class="topbar__actions">
        <button onclick="location.href='dashboard.html'" class="btn btn--ghost">‚Üê Voltar ao Dashboard</button>
        <button id="logoutBtn" class="btn btn--ghost">üö™ Sair</button>
      </div>
    </div>
  </header>

  <main class="container" style="max-width: 900px; margin-top: 24px;">

    <!-- INFORMA√á√ïES DO USU√ÅRIO -->
    <section class="card">
      <h2>üë§ INFORMA√á√ïES DO USU√ÅRIO</h2>
      <div class="form">
        <div class="form-group">
          <label>Nome</label>
          <input type="text" id="displayNome" readonly class="input--readonly" />
        </div>

        <div class="form-group">
          <label>E-mail</label>
          <input type="email" id="displayEmail" readonly class="input--readonly" />
        </div>

        <div class="form-group">
          <label>Conta criada em</label>
          <input type="text" id="displayDataCriacao" readonly class="input--readonly" />
        </div>
      </div>
    </section>

    <!-- PERFIL FINANCEIRO -->
    <section class="card">
      <h2>üìä PERFIL FINANCEIRO</h2>
      <p class="text-muted" style="margin-bottom: 20px;">
        Defina seu perfil e como deseja distribuir sua renda mensalmente (planejamento).
      </p>

      <form id="formPerfil" class="form">
        <div class="form-group">
          <label for="tipoPerfil">Tipo de Perfil</label>
          <select id="tipoPerfil" required>
            <option value="">Selecione seu perfil</option>
            <option value="responsavel">üéØ Respons√°vel (foco em estabilidade)</option>
            <option value="conservador">üõ°Ô∏è Conservador (m√°xima seguran√ßa)</option>
            <option value="livre">üåü Livre (mais flexibilidade)</option>
          </select>
          <small class="text-muted">Cada perfil tem percentuais sugeridos diferentes</small>
        </div>

        <div class="form-group">
          <label for="percDespesasEssenciais">Despesas Essenciais (%)</label>
          <input type="number" id="percDespesasEssenciais" min="0" max="100" step="1" placeholder="Ex: 50" required />
          <small class="text-muted">Moradia, alimenta√ß√£o, transporte, sa√∫de...</small>
        </div>

        <div class="form-group">
          <label for="percDespesasLivres">Despesas Livres (%)</label>
          <input type="number" id="percDespesasLivres" min="0" max="100" step="1" placeholder="Ex: 30" required />
          <small class="text-muted">Lazer, entretenimento, extras...</small>
        </div>

        <div class="form-group">
          <label for="percPoupanca">Poupan√ßa / Investimentos (%)</label>
          <input type="number" id="percPoupanca" min="0" max="100" step="1" placeholder="Ex: 20" required />
          <small class="text-muted">Reserva de emerg√™ncia, investimentos...</small>
        </div>

        <div class="form-group">
          <label for="percQuitacaoDividas">% para quitar d√≠vidas</label>
          <input type="number" id="percQuitacaoDividas" min="0" max="100" step="1" placeholder="Ex: 10" required />
          <small class="text-muted">Planejamento educacional. (N√£o automatiza nada no dashboard)</small>
        </div>

        <div id="totalPerc" class="status status--info" style="margin-top: 16px;">
          Total: <strong>0%</strong>
        </div>

        <button type="submit" class="btn btn--primary" style="width: 100%; margin-top: 8px;">
          üíæ Salvar Perfil Financeiro
        </button>
      </form>
    </section>

    <!-- PERFIS SUGERIDOS -->
    <section class="card">
      <h2>üí° PERFIS SUGERIDOS</h2>
      <div style="display: grid; gap: 16px;">

        <div class="suggestion-box">
          <h3 style="margin-bottom: 8px;">üéØ Respons√°vel</h3>
          <p class="text-muted" style="font-size: 13px; margin-bottom: 12px;">
            Equil√≠brio entre seguran√ßa e qualidade de vida
          </p>
          <div class="suggestion-badges">
            <span class="badge badge-despesa">50% Essenciais</span>
            <span class="badge badge-despesa">25% Livres</span>
            <span class="badge badge-poupanca">15% Poupan√ßa</span>
            <span class="badge badge-divida">10% Quitar D√≠vidas</span>
          </div>
          <button onclick="aplicarPerfil('responsavel')" class="btn btn--ghost btn-mini" style="margin-top: 12px;">
            Aplicar este perfil
          </button>
        </div>

        <div class="suggestion-box">
          <h3 style="margin-bottom: 8px;">üõ°Ô∏è Conservador</h3>
          <p class="text-muted" style="font-size: 13px; margin-bottom: 12px;">
            M√°xima seguran√ßa financeira e reservas
          </p>
          <div class="suggestion-badges">
            <span class="badge badge-despesa">55% Essenciais</span>
            <span class="badge badge-despesa">15% Livres</span>
            <span class="badge badge-poupanca">20% Poupan√ßa</span>
            <span class="badge badge-divida">10% Quitar D√≠vidas</span>
          </div>
          <button onclick="aplicarPerfil('conservador')" class="btn btn--ghost btn-mini" style="margin-top: 12px;">
            Aplicar este perfil
          </button>
        </div>

        <div class="suggestion-box">
          <h3 style="margin-bottom: 8px;">üåü Livre</h3>
          <p class="text-muted" style="font-size: 13px; margin-bottom: 12px;">
            Mais liberdade, sem perder um m√≠nimo de disciplina
          </p>
          <div class="suggestion-badges">
            <span class="badge badge-despesa">45% Essenciais</span>
            <span class="badge badge-despesa">35% Livres</span>
            <span class="badge badge-poupanca">10% Poupan√ßa</span>
            <span class="badge badge-divida">10% Quitar D√≠vidas</span>
          </div>
          <button onclick="aplicarPerfil('livre')" class="btn btn--ghost btn-mini" style="margin-top: 12px;">
            Aplicar este perfil
          </button>
        </div>

      </div>
    </section>

    <!-- GERENCIADORES (v3.1) -->
    <section class="card">
      <h2>‚öôÔ∏è GERENCIADORES (v3.1)</h2>
      <p class="text-muted" style="margin-top: 0;">
        Personalize as listas do sistema. Voc√™ pode <strong>ativar/desativar</strong> e <strong>renomear</strong> itens existentes.
        <br /><small>Obs.: n√£o cria novos itens e n√£o apaga hist√≥rico.</small>
      </p>

      <div class="manager-grid">
        <!-- Categorias -->
        <div class="manager-card">
          <div class="manager-header">
            <h3 style="margin:0;">üìå Categorias</h3>
            <select id="catGrupo" class="manager-select">
              <option value="receita">Receita</option>
              <option value="poupanca">Poupan√ßa</option>
              <option value="despesa_essencial">Despesa Essencial</option>
              <option value="despesa_livre">Despesa Livre</option>
              <option value="divida">D√≠vidas</option>
            </select>
          </div>

          <div id="catLista" class="manager-list"></div>

          <div class="manager-actions">
            <button id="btnSalvarCats" class="btn btn--primary" type="button">Salvar Categorias</button>
            <button id="btnResetCats" class="btn btn--ghost" type="button">Restaurar padr√£o</button>
          </div>
        </div>

        <!-- Bancos -->
        <div class="manager-card">
          <div class="manager-header">
            <h3 style="margin:0;">üè¶ Bancos</h3>
            <select id="bankTipo" class="manager-select">
              <option value="receita">Receita</option>
              <option value="poupanca">Poupan√ßa</option>
              <option value="despesa">Despesa</option>
              <option value="divida">D√≠vidas</option>
            </select>
          </div>

          <div id="bankLista" class="manager-list"></div>

          <div class="manager-actions">
            <button id="btnSalvarBanks" class="btn btn--primary" type="button">Salvar Bancos</button>
            <button id="btnResetBanks" class="btn btn--ghost" type="button">Restaurar padr√£o</button>
          </div>
        </div>
      </div>

      <div class="status status--info" style="margin-top: 14px;">
        Dica: as mudan√ßas aparecem nos selects do Dashboard automaticamente ao recarregar a p√°gina.
      </div>
    </section>

  </main>

  <!-- scripts base (v3.1) -->
  <script src="js/constantes.js"></script>
  <script src="js/config.js"></script>

  <script>
    const USER_KEY = "gf_erp_user";
    const LOGGED_KEY = "gf_erp_logged";
    const PERFIL_KEY = "gf_erp_perfil";

    // Verificar login
    if (localStorage.getItem(LOGGED_KEY) !== "true") {
      window.location.href = "index.html";
    }

    // Garantir configs (se n√£o existirem ainda)
    if (window.ERP_CFG) {
      ERP_CFG.ensureCategoriesConfig();
      ERP_CFG.ensureBanksConfig();
    }

    // Carregar dados do usu√°rio
    const user = JSON.parse(localStorage.getItem(USER_KEY) || 'null');
    if (user) {
      document.getElementById('displayNome').value = user.nome || '';
      document.getElementById('displayEmail').value = user.email || '';
      if (user.dataCriacao) {
        const data = new Date(user.dataCriacao);
        document.getElementById('displayDataCriacao').value = data.toLocaleDateString('pt-BR');
      }
    }

    // Carregar perfil salvo
    const perfilSalvo = JSON.parse(localStorage.getItem(PERFIL_KEY) || 'null');
    if (perfilSalvo) {
      document.getElementById('tipoPerfil').value = perfilSalvo.tipo || '';
      document.getElementById('percDespesasEssenciais').value = perfilSalvo.percEssenciais ?? '';
      document.getElementById('percDespesasLivres').value = perfilSalvo.percLivres ?? '';
      document.getElementById('percPoupanca').value = perfilSalvo.percPoupanca ?? '';
      document.getElementById('percQuitacaoDividas').value = perfilSalvo.percQuitacaoDividas ?? '';
      atualizarTotal();
    }

    function atualizarTotal() {
      const essenciais = Number(document.getElementById('percDespesasEssenciais').value) || 0;
      const livres = Number(document.getElementById('percDespesasLivres').value) || 0;
      const poupanca = Number(document.getElementById('percPoupanca').value) || 0;
      const quita = Number(document.getElementById('percQuitacaoDividas').value) || 0;

      const total = essenciais + livres + poupanca + quita;
      const totalEl = document.getElementById('totalPerc');

      totalEl.innerHTML = `Total: <strong>${total}%</strong>`;

      if (total === 100) {
        totalEl.className = 'status status--ok';
        totalEl.innerHTML += ' ‚úì Perfeito!';
      } else if (total > 100) {
        totalEl.className = 'status status--error';
        totalEl.innerHTML += ' ‚ö†Ô∏è Acima de 100%';
      } else {
        totalEl.className = 'status status--info';
        totalEl.innerHTML += ` (faltam ${100 - total}%)`;
      }
    }

    ['percDespesasEssenciais', 'percDespesasLivres', 'percPoupanca', 'percQuitacaoDividas'].forEach(id => {
      document.getElementById(id).addEventListener('input', atualizarTotal);
    });

    // Perfis sugeridos
    function aplicarPerfil(tipo) {
      const perfis = {
        responsavel: { essenciais: 50, livres: 25, poupanca: 15, quita: 10 },
        conservador: { essenciais: 55, livres: 15, poupanca: 20, quita: 10 },
        livre: { essenciais: 45, livres: 35, poupanca: 10, quita: 10 }
      };

      const p = perfis[tipo];
      if (!p) return;

      document.getElementById('tipoPerfil').value = tipo;
      document.getElementById('percDespesasEssenciais').value = p.essenciais;
      document.getElementById('percDespesasLivres').value = p.livres;
      document.getElementById('percPoupanca').value = p.poupanca;
      document.getElementById('percQuitacaoDividas').value = p.quita;

      atualizarTotal();
      showToast(`‚úì Perfil "${tipo}" aplicado!`, 'success');
    }
    window.aplicarPerfil = aplicarPerfil;

    // Salvar perfil
    document.getElementById('formPerfil').addEventListener('submit', (e) => {
      e.preventDefault();

      const essenciais = Number(document.getElementById('percDespesasEssenciais').value);
      const livres = Number(document.getElementById('percDespesasLivres').value);
      const poupanca = Number(document.getElementById('percPoupanca').value);
      const quita = Number(document.getElementById('percQuitacaoDividas').value);
      const total = essenciais + livres + poupanca + quita;

      if (total !== 100) {
        showToast('‚ö†Ô∏è A soma dos percentuais deve ser exatamente 100%', 'error');
        return;
      }

      const perfil = {
        tipo: document.getElementById('tipoPerfil').value,
        percEssenciais: essenciais,
        percLivres: livres,
        percPoupanca: poupanca,
        percQuitacaoDividas: quita,
        dataAtualizacao: new Date().toISOString()
      };

      localStorage.setItem(PERFIL_KEY, JSON.stringify(perfil));
      showToast('‚úì Perfil financeiro salvo!', 'success');

      setTimeout(() => window.location.href = 'dashboard.html', 900);
    });

    // -------------------------
    // GERENCIADOR DE CATEGORIAS
    // -------------------------
    const catGrupo = document.getElementById('catGrupo');
    const catLista = document.getElementById('catLista');

    function renderCatList(kind) {
      const items = (window.ERP_CFG ? ERP_CFG.getCategoryConfig(kind) : []) || [];
      catLista.innerHTML = '';
      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'manager-row';
        row.innerHTML = `
          <label class="manager-toggle">
            <input type="checkbox" data-idx="${idx}" ${it.active ? 'checked' : ''} />
            <span>Ativo</span>
          </label>
          <input class="manager-input" type="text" data-idx="${idx}" value="${it.label}" />
          <span class="manager-muted">${it.originalLabel}</span>
        `;
        catLista.appendChild(row);
      });
    }

    function collectCatList(kind) {
      const items = ERP_CFG.getCategoryConfig(kind).map(x => ({...x}));
      catLista.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
        const idx = Number(cb.dataset.idx);
        if (items[idx]) items[idx].active = cb.checked;
      });
      catLista.querySelectorAll('input.manager-input').forEach((inp) => {
        const idx = Number(inp.dataset.idx);
        if (items[idx]) items[idx].label = (inp.value || '').trim() || items[idx].originalLabel;
      });

      // fallback: garantir pelo menos 1 ativo
      if (!items.some(i => i.active)) {
        items[0].active = true;
      }
      return items;
    }

    catGrupo.addEventListener('change', () => renderCatList(catGrupo.value));
    renderCatList(catGrupo.value);

    document.getElementById('btnSalvarCats').addEventListener('click', () => {
      const kind = catGrupo.value;
      ERP_CFG.setCategoryConfig(kind, collectCatList(kind));
      showToast('‚úì Categorias atualizadas!', 'success');
    });

    document.getElementById('btnResetCats').addEventListener('click', () => {
      // reset: recria defaults e re-render
      localStorage.removeItem('gf_erp_cfg_categorias');
      ERP_CFG.ensureCategoriesConfig();
      renderCatList(catGrupo.value);
      showToast('‚úì Categorias restauradas ao padr√£o!', 'info');
    });

    // -------------------------
    // GERENCIADOR DE BANCOS
    // -------------------------
    const bankTipo = document.getElementById('bankTipo');
    const bankLista = document.getElementById('bankLista');

    function renderBankList(type) {
      const items = (window.ERP_CFG ? ERP_CFG.getBankConfig(type) : []) || [];
      bankLista.innerHTML = '';
      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'manager-row';
        row.innerHTML = `
          <label class="manager-toggle">
            <input type="checkbox" data-idx="${idx}" ${it.active ? 'checked' : ''} />
            <span>Ativo</span>
          </label>
          <input class="manager-input" type="text" data-idx="${idx}" value="${it.label}" />
          <span class="manager-muted">${it.originalLabel}</span>
        `;
        bankLista.appendChild(row);
      });
    }

    function collectBankList(type) {
      const items = ERP_CFG.getBankConfig(type).map(x => ({...x}));
      bankLista.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
        const idx = Number(cb.dataset.idx);
        if (items[idx]) items[idx].active = cb.checked;
      });
      bankLista.querySelectorAll('input.manager-input').forEach((inp) => {
        const idx = Number(inp.dataset.idx);
        if (items[idx]) items[idx].label = (inp.value || '').trim() || items[idx].originalLabel;
      });
      if (!items.some(i => i.active)) {
        items[0].active = true;
      }
      return items;
    }

    bankTipo.addEventListener('change', () => renderBankList(bankTipo.value));
    renderBankList(bankTipo.value);

    document.getElementById('btnSalvarBanks').addEventListener('click', () => {
      const type = bankTipo.value;
      ERP_CFG.setBankConfig(type, collectBankList(type));
      showToast('‚úì Bancos atualizados!', 'success');
    });

    document.getElementById('btnResetBanks').addEventListener('click', () => {
      localStorage.removeItem('gf_erp_cfg_bancos');
      ERP_CFG.ensureBanksConfig();
      renderBankList(bankTipo.value);
      showToast('‚úì Bancos restaurados ao padr√£o!', 'info');
    });

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast--${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm("Deseja realmente sair?")) {
        localStorage.setItem(LOGGED_KEY, "false");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
