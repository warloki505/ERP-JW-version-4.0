<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Configure seu perfil financeiro no ERP JW v4.0" />
  <meta name="author" content="JW" />
  <meta name="theme-color" content="#3b82f6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>ERP Financeiro JW - Perfil Financeiro v4.0</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="topbar">
    <div class="container topbar__row">
      <h1>ğŸ’° ERP Financeiro JW v4.0</h1>
      <div class="topbar__actions">
        <button onclick="location.href='dashboard.html'" class="btn btn--ghost js-dashboard">â† Voltar ao Dashboard</button>
        <button id="logoutBtn" class="btn btn--ghost js-logout">ğŸšª Sair</button>
        <button class="btn btn--ghost btn-mini js-theme-toggle">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <main class="container" style="max-width: 900px; margin-top: 24px;">

    <!-- INFORMAÃ‡Ã•ES DO USUÃRIO -->
    <section class="card">
      <h2>ğŸ‘¤ INFORMAÃ‡Ã•ES DO USUÃRIO</h2>
      <div class="form">
        <div class="form-group">
          <label>Nome</label>
          <input type="text" id="displayNome" readonly class="input--readonly" />
        </div>

        <div class="form-group">
          <label>E-mail</label>
          <input type="email" id="displayEmail" readonly class="input--readonly" />
        </div>

        <div class="form-group">
          <label>Conta criada em</label>
          <input type="text" id="displayDataCriacao" readonly class="input--readonly" />
        </div>
      </div>
    </section>

    <!-- PERFIL FINANCEIRO -->
    <section class="card">
      <h2>ğŸ“Š PERFIL FINANCEIRO</h2>
      <p class="text-muted" style="margin-bottom: 20px;">
        Defina seu perfil e como deseja distribuir sua renda mensalmente.
      </p>

      <form id="formPerfil" class="form">
        <div class="form-group">
          <label for="tipoPerfil">Tipo de Perfil</label>
          <select id="tipoPerfil" required>
            <option value="">Selecione seu perfil</option>
            <option value="responsavel">ğŸ¯ ResponsÃ¡vel (50/20/20/10)</option>
            <option value="conservador">ğŸ›¡ï¸ Conservador (50/10/30/10)</option>
            <option value="poupador_agressivo">ğŸ’° Poupador Agressivo (45/15/30/10)</option>
            <option value="livre">ğŸŒŸ Livre (50/30/10/10)</option>
            <option value="quitador">ğŸ¯ Quitador de DÃ­vidas (45/15/15/25)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="percDespesasEssenciais">Despesas Essenciais (%)</label>
          <input type="number" id="percDespesasEssenciais" min="0" max="100" step="1" required />
        </div>

        <div class="form-group">
          <label for="percDespesasLivres">Despesas Livres (%)</label>
          <input type="number" id="percDespesasLivres" min="0" max="100" step="1" required />
        </div>

        <div class="form-group">
          <label for="percPoupanca">PoupanÃ§a / Investimentos (%)</label>
          <input type="number" id="percPoupanca" min="0" max="100" step="1" required />
        </div>

        <div class="form-group">
          <label for="percQuitacaoDividas">% para quitar dÃ­vidas</label>
          <input type="number" id="percQuitacaoDividas" min="0" max="100" step="1" required />
        </div>

        <div id="totalPerc" class="status status--info" style="margin-top: 16px;">
          Total: <strong>0%</strong>
        </div>

        <button type="submit" class="btn btn--primary" style="width: 100%; margin-top: 8px;">
          ğŸ’¾ Salvar Perfil
        </button>
      </form>
    </section>

    <!-- PERFIS SUGERIDOS -->
    <section class="card">
      <h2>ğŸ’¡ PERFIS SUGERIDOS</h2>
      <div style="display: grid; gap: 16px;">

        <div class="suggestion-box">
          <h3>ğŸ¯ ResponsÃ¡vel</h3>
          <p class="text-muted">50% Essenciais | 20% Livres | 20% PoupanÃ§a | 10% DÃ­vidas</p>
          <button onclick="aplicarPerfil('responsavel')" class="btn btn--ghost btn-mini">Aplicar</button>
        </div>

        <div class="suggestion-box">
          <h3>ğŸ›¡ï¸ Conservador</h3>
          <p class="text-muted">50% Essenciais | 10% Livres | 30% PoupanÃ§a | 10% DÃ­vidas</p>
          <button onclick="aplicarPerfil('conservador')" class="btn btn--ghost btn-mini">Aplicar</button>
        </div>

        <div class="suggestion-box">
          <h3>ğŸ’° Poupador Agressivo</h3>
          <p class="text-muted">45% Essenciais | 15% Livres | 30% PoupanÃ§a | 10% DÃ­vidas</p>
          <button onclick="aplicarPerfil('poupador_agressivo')" class="btn btn--ghost btn-mini">Aplicar</button>
        </div>

        <div class="suggestion-box">
          <h3>ğŸŒŸ Livre</h3>
          <p class="text-muted">50% Essenciais | 30% Livres | 10% PoupanÃ§a | 10% DÃ­vidas</p>
          <button onclick="aplicarPerfil('livre')" class="btn btn--ghost btn-mini">Aplicar</button>
        </div>

        <div class="suggestion-box">
          <h3>ğŸ¯ Quitador de DÃ­vidas</h3>
          <p class="text-muted">45% Essenciais | 15% Livres | 15% PoupanÃ§a | 25% DÃ­vidas</p>
          <button onclick="aplicarPerfil('quitador')" class="btn btn--ghost btn-mini">Aplicar</button>
        </div>

      </div>
    </section>

    <!-- GERENCIADORES -->
    <section class="card">
      <h2>âš™ï¸ GERENCIADORES</h2>

      <div class="manager-grid">
        <!-- Categorias -->
        <div class="manager-card">
          <div class="manager-header">
            <h3>ğŸ“Œ Categorias</h3>
            <select id="catGrupo" class="manager-select">
              <option value="receita">Receita</option>
              <option value="poupanca">PoupanÃ§a</option>
              <option value="despesa_essencial">Essencial</option>
              <option value="despesa_livre">Livre</option>
              <option value="divida">DÃ­vidas</option>
            </select>
          </div>
          <div id="catLista" class="manager-list"></div>
          <div class="manager-actions">
            <button id="btnSalvarCats" class="btn btn--primary">Salvar</button>
            <button id="btnResetCats" class="btn btn--ghost">Restaurar</button>
          </div>
        </div>

        <!-- Bancos -->
        <div class="manager-card">
          <div class="manager-header">
            <h3>ğŸ¦ Bancos</h3>
            <select id="bankTipo" class="manager-select">
              <option value="receita">Receita</option>
              <option value="poupanca">PoupanÃ§a</option>
              <option value="despesa">Despesa</option>
              <option value="divida">DÃ­vidas</option>
            </select>
          </div>
          <div id="bankLista" class="manager-list"></div>
          <div class="manager-actions">
            <button id="btnSalvarBanks" class="btn btn--primary">Salvar</button>
            <button id="btnResetBanks" class="btn btn--ghost">Restaurar</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- SCRIPTS -->
  <script src="js/constantes.js"></script>
  <script src="js/config.js"></script>
  <script src="js/script.js"></script>

  <script>
    const USER_KEY = "gf_erp_user";
    const LOGGED_KEY = "gf_erp_logged";
    const PERFIL_KEY = "gf_erp_perfil";

    if (localStorage.getItem(LOGGED_KEY) !== "true") {
      window.location.href = "index.html";
    }

    if (window.ERP_CFG) {
      ERP_CFG.ensureCategoriesConfig();
      ERP_CFG.ensureBanksConfig();
    }

    const user = JSON.parse(localStorage.getItem(USER_KEY) || 'null');
    if (user) {
      document.getElementById('displayNome').value = user.nome || '';
      document.getElementById('displayEmail').value = user.email || '';
      if (user.dataCriacao) {
        const data = new Date(user.dataCriacao);
        document.getElementById('displayDataCriacao').value = data.toLocaleDateString('pt-BR');
      }
    }

    const perfilSalvo = JSON.parse(localStorage.getItem(PERFIL_KEY) || 'null');
    if (perfilSalvo) {
      document.getElementById('tipoPerfil').value = perfilSalvo.tipo || '';
      document.getElementById('percDespesasEssenciais').value = perfilSalvo.percEssenciais ?? '';
      document.getElementById('percDespesasLivres').value = perfilSalvo.percLivres ?? '';
      document.getElementById('percPoupanca').value = perfilSalvo.percPoupanca ?? '';
      document.getElementById('percQuitacaoDividas').value = perfilSalvo.percQuitacaoDividas ?? '';
      atualizarTotal();
    }

    function atualizarTotal() {
      const essenciais = Number(document.getElementById('percDespesasEssenciais').value) || 0;
      const livres = Number(document.getElementById('percDespesasLivres').value) || 0;
      const poupanca = Number(document.getElementById('percPoupanca').value) || 0;
      const quita = Number(document.getElementById('percQuitacaoDividas').value) || 0;
      const total = essenciais + livres + poupanca + quita;
      const totalEl = document.getElementById('totalPerc');
      totalEl.innerHTML = `Total: <strong>${total}%</strong>`;
      if (total === 100) {
        totalEl.className = 'status status--ok';
      } else if (total > 100) {
        totalEl.className = 'status status--error';
      } else {
        totalEl.className = 'status status--info';
      }
    }

    ['percDespesasEssenciais', 'percDespesasLivres', 'percPoupanca', 'percQuitacaoDividas'].forEach(id => {
      document.getElementById(id).addEventListener('input', atualizarTotal);
    });

    function aplicarPerfil(tipo) {
      const perfis = {
        responsavel: { essenciais: 50, livres: 20, poupanca: 20, quita: 10 },
        conservador: { essenciais: 50, livres: 10, poupanca: 30, quita: 10 },
        poupador_agressivo: { essenciais: 45, livres: 15, poupanca: 30, quita: 10 },
        livre: { essenciais: 50, livres: 30, poupanca: 10, quita: 10 },
        quitador: { essenciais: 45, livres: 15, poupanca: 15, quita: 25 }
      };
      const p = perfis[tipo];
      if (!p) return;
      document.getElementById('tipoPerfil').value = tipo;
      document.getElementById('percDespesasEssenciais').value = p.essenciais;
      document.getElementById('percDespesasLivres').value = p.livres;
      document.getElementById('percPoupanca').value = p.poupanca;
      document.getElementById('percQuitacaoDividas').value = p.quita;
      atualizarTotal();
      alert(`âœ“ Perfil "${tipo}" aplicado!`);
    }
    window.aplicarPerfil = aplicarPerfil;

    document.getElementById('formPerfil').addEventListener('submit', (e) => {
      e.preventDefault();
      const essenciais = Number(document.getElementById('percDespesasEssenciais').value);
      const livres = Number(document.getElementById('percDespesasLivres').value);
      const poupanca = Number(document.getElementById('percPoupanca').value);
      const quita = Number(document.getElementById('percQuitacaoDividas').value);
      const total = essenciais + livres + poupanca + quita;
      if (total !== 100) {
        alert('âš ï¸ A soma deve ser 100%');
        return;
      }
      const perfil = {
        tipo: document.getElementById('tipoPerfil').value,
        percEssenciais: essenciais,
        percLivres: livres,
        percPoupanca: poupanca,
        percQuitacaoDividas: quita,
        dataAtualizacao: new Date().toISOString()
      };
      localStorage.setItem(PERFIL_KEY, JSON.stringify(perfil));
      alert('âœ“ Perfil salvo!');
      setTimeout(() => window.location.href = 'dashboard.html', 900);
    });

    // GERENCIADOR DE CATEGORIAS
    const catGrupo = document.getElementById('catGrupo');
    const catLista = document.getElementById('catLista');

    function renderCatList(kind) {
      const items = (window.ERP_CFG ? ERP_CFG.getCategoryConfig(kind) : []) || [];
      catLista.innerHTML = '';
      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'manager-row';
        row.innerHTML = `
          <label class="manager-toggle">
            <input type="checkbox" data-idx="${idx}" ${it.active ? 'checked' : ''} />
            <span>Ativo</span>
          </label>
          <input class="manager-input" type="text" data-idx="${idx}" value="${it.label}" />
          <span class="manager-muted">${it.originalLabel}</span>
        `;
        catLista.appendChild(row);
      });
    }

    function collectCatList(kind) {
      const items = ERP_CFG.getCategoryConfig(kind).map(x => ({...x}));
      catLista.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
        const idx = Number(cb.dataset.idx);
        if (items[idx]) items[idx].active = cb.checked;
      });
      catLista.querySelectorAll('input.manager-input').forEach((inp) => {
        const idx = Number(inp.dataset.idx);
        if (items[idx]) items[idx].label = (inp.value || '').trim() || items[idx].originalLabel;
      });
      if (!items.some(i => i.active)) items[0].active = true;
      return items;
    }

    catGrupo.addEventListener('change', () => renderCatList(catGrupo.value));
    renderCatList(catGrupo.value);

    document.getElementById('btnSalvarCats').addEventListener('click', () => {
      const kind = catGrupo.value;
      ERP_CFG.setCategoryConfig(kind, collectCatList(kind));
      alert('âœ“ Categorias atualizadas!');
    });

    document.getElementById('btnResetCats').addEventListener('click', () => {
      localStorage.removeItem('gf_erp_cfg_categorias');
      ERP_CFG.ensureCategoriesConfig();
      renderCatList(catGrupo.value);
      alert('âœ“ Categorias restauradas!');
    });

    // GERENCIADOR DE BANCOS
    const bankTipo = document.getElementById('bankTipo');
    const bankLista = document.getElementById('bankLista');

    function renderBankList(type) {
      const items = (window.ERP_CFG ? ERP_CFG.getBankConfig(type) : []) || [];
      bankLista.innerHTML = '';
      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'manager-row';
        row.innerHTML = `
          <label class="manager-toggle">
            <input type="checkbox" data-idx="${idx}" ${it.active ? 'checked' : ''} />
            <span>Ativo</span>
          </label>
          <input class="manager-input" type="text" data-idx="${idx}" value="${it.label}" />
          <span class="manager-muted">${it.originalLabel}</span>
        `;
        bankLista.appendChild(row);
      });
    }

    function collectBankList(type) {
      const items = ERP_CFG.getBankConfig(type).map(x => ({...x}));
      bankLista.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
        const idx = Number(cb.dataset.idx);
        if (items[idx]) items[idx].active = cb.checked;
      });
      bankLista.querySelectorAll('input.manager-input').forEach((inp) => {
        const idx = Number(inp.dataset.idx);
        if (items[idx]) items[idx].label = (inp.value || '').trim() || items[idx].originalLabel;
      });
      if (!items.some(i => i.active)) items[0].active = true;
      return items;
    }

    bankTipo.addEventListener('change', () => renderBankList(bankTipo.value));
    renderBankList(bankTipo.value);

    document.getElementById('btnSalvarBanks').addEventListener('click', () => {
      const type = bankTipo.value;
      ERP_CFG.setBankConfig(type, collectBankList(type));
      alert('âœ“ Bancos atualizados!');
    });

    document.getElementById('btnResetBanks').addEventListener('click', () => {
      localStorage.removeItem('gf_erp_cfg_bancos');
      ERP_CFG.ensureBanksConfig();
      renderBankList(bankTipo.value);
      alert('âœ“ Bancos restaurados!');
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm("Deseja realmente sair?")) {
        localStorage.setItem(LOGGED_KEY, "false");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
