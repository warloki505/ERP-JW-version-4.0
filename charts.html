<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="RelatÃ³rios e grÃ¡ficos do ERP Financeiro JW v4.0" />
  <meta name="author" content="JW" />
  <meta name="theme-color" content="#3b82f6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>ERP Financeiro JW v4.0 - RelatÃ³rio Completo</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
  <header class="topbar no-print">
    <div class="container topbar__row">
      <h1>ğŸ’° ERP Financeiro JW v4.0 - RelatÃ³rios</h1>
      <div class="topbar__actions">
        <button onclick="location.href='dashboard.html'" class="btn btn--ghost js-dashboard">â† Dashboard</button>
        <button id="logoutBtn" class="btn btn--ghost js-logout">ğŸšª Sair</button>
        <button class="btn btn--ghost btn-mini js-theme-toggle">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top: 24px;">
    
    <!-- CABEÃ‡ALHO -->
    <section class="card">
      <div style="text-align: center;">
        <h1>ğŸ“Š RELATÃ“RIO FINANCEIRO</h1>
        <h2 style="color: var(--primary); margin: 8px 0;" id="monthLabel"></h2>
        <p class="text-muted">Gerado em: <span id="dataGeracao"></span></p>
      </div>
    </section>

    <!-- RESUMO DOS 6 KPIs -->
    <section class="card">
      <h2>ğŸ’¹ RESUMO EXECUTIVO</h2>
      <div class="kpi-grid">
        <div class="kpi kpi--receita"><div class="kpi__title">Renda</div><div class="kpi__value" id="kpiRenda">R$ 0</div></div>
        <div class="kpi kpi--poupanca"><div class="kpi__title">PoupanÃ§a</div><div class="kpi__value" id="kpiPoupanca">R$ 0</div></div>
        <div class="kpi kpi--essenciais"><div class="kpi__title">Essenciais</div><div class="kpi__value" id="kpiEssenciais">R$ 0</div></div>
        <div class="kpi kpi--livres"><div class="kpi__title">Livres</div><div class="kpi__value" id="kpiLivres">R$ 0</div></div>
        <div class="kpi kpi--dividas"><div class="kpi__title">DÃVIDAS</div><div class="kpi__value" id="kpiDividas">R$ 0</div></div>
        <div class="kpi kpi--highlight"><div class="kpi__title">Saldo</div><div class="kpi__value" id="kpiSaldo">R$ 0</div></div>
      </div>
    </section>

    <!-- GRÃFICOS -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
      <section class="card"><h3>ğŸ“Š DistribuiÃ§Ã£o</h3><canvas id="chartPizza"></canvas></section>
      <section class="card"><h3>ğŸ“Š Comparativo</h3><canvas id="chartBarras"></canvas></section>
    </div>

    <section class="card"><h3>ğŸ’³ Despesas por Categoria</h3><canvas id="chartCategorias"></canvas></section>
    <section class="card"><h3>âš ï¸ DÃ­vidas por Tipo</h3><canvas id="chartDividas"></canvas></section>
    <section class="card"><h3>ğŸ“ˆ EvoluÃ§Ã£o 6 Meses</h3><canvas id="chartEvolucao"></canvas></section>

    <!-- TABELA -->
    <section class="card">
      <h2>ğŸ“‹ LANÃ‡AMENTOS DO MÃŠS</h2>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Data</th><th>Tipo</th><th>Categoria</th><th>Valor</th></tr></thead>
          <tbody id="tbodyLancamentos"></tbody>
        </table>
      </div>
    </section>

    <section class="footer-actions no-print">
      <button onclick="window.print()" class="btn btn--primary">ğŸ–¨ï¸ PDF</button>
      <button onclick="location.reload()" class="btn btn--ghost">ğŸ”„ Atualizar</button>
      <button class="btn btn--ghost js-back">â†©ï¸ Voltar</button>
    </section>

  </main>

  <!-- SCRIPTS -->
  <script src="js/constantes.js"></script>
  <script src="js/config.js"></script>
  <script src="js/script.js"></script>

  <script>
    const LOGGED_KEY = "gf_erp_logged";
    if (localStorage.getItem(LOGGED_KEY) !== "true") window.location.href = "index.html";

    function getMonthId(date = new Date()) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
    }

    function getMonthLabel(monthId) {
      const [year, month] = monthId.split('-');
      return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    }

    function brl(v) {
      return (Number(v) || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function calcularResumo(list) {
      let renda = 0, poupanca = 0, essenciais = 0, livres = 0, dividas = 0;
      list.forEach((t) => {
        const v = Number(t.valor) || 0;
        if (t.tipo === "receita") renda += v;
        if (t.tipo === "poupanca") poupanca += v;
        if (t.tipo === "divida") dividas += v;
        if (t.tipo === "despesa" && t.subtipo === "essencial") essenciais += v;
        if (t.tipo === "despesa" && t.subtipo === "livre") livres += v;
      });
      return { renda, poupanca, essenciais, livres, dividas, saldo: renda - poupanca - essenciais - livres - dividas };
    }

    const activeMonth = getMonthId();
    const tx = JSON.parse(localStorage.getItem(`gf_erp_tx_${activeMonth}`) || '[]');
    const r = calcularResumo(tx);

    document.getElementById('monthLabel').textContent = getMonthLabel(activeMonth);
    document.getElementById('dataGeracao').textContent = new Date().toLocaleString('pt-BR');
    document.getElementById('kpiRenda').textContent = brl(r.renda);
    document.getElementById('kpiPoupanca').textContent = brl(r.poupanca);
    document.getElementById('kpiEssenciais').textContent = brl(r.essenciais);
    document.getElementById('kpiLivres').textContent = brl(r.livres);
    document.getElementById('kpiDividas').textContent = brl(r.dividas);
    document.getElementById('kpiSaldo').textContent = brl(r.saldo);

    const cores = { receita: '#10b981', poupanca: '#3b82f6', essenciais: '#ea580c', livres: '#d97706', dividas: '#dc2626', saldo: '#8b5cf6' };

    new Chart(document.getElementById('chartPizza'), {
      type: 'doughnut',
      data: {
        labels: ['Essenciais', 'Livres', 'PoupanÃ§a', 'DÃ­vidas', 'Saldo'],
        datasets: [{
          data: [r.essenciais, r.livres, r.poupanca, r.dividas, Math.max(0, r.saldo)],
          backgroundColor: [cores.essenciais, cores.livres, cores.poupanca, cores.dividas, cores.saldo]
        }]
      }
    });

    new Chart(document.getElementById('chartBarras'), {
      type: 'bar',
      data: {
        labels: ['Receitas', 'Despesas', 'PoupanÃ§a', 'DÃ­vidas'],
        datasets: [{
          data: [r.renda, r.essenciais + r.livres, r.poupanca, r.dividas],
          backgroundColor: [cores.receita, cores.essenciais, cores.poupanca, cores.dividas]
        }]
      }
    });

    const despCat = {};
    tx.forEach(t => { if (t.tipo === 'despesa') despCat[t.categoria] = (despCat[t.categoria] || 0) + Number(t.valor); });
    const despSorted = Object.entries(despCat).sort((a, b) => b[1] - a[1]).slice(0, 10);
    new Chart(document.getElementById('chartCategorias'), {
      type: 'bar',
      data: {
        labels: despSorted.map(s => s[0]),
        datasets: [{ data: despSorted.map(s => s[1]), backgroundColor: cores.essenciais }]
      },
      options: { indexAxis: 'y' }
    });

    const divTipo = {};
    tx.forEach(t => { if (t.tipo === 'divida') divTipo[t.categoria] = (divTipo[t.categoria] || 0) + Number(t.valor); });
    if (Object.keys(divTipo).length > 0) {
      new Chart(document.getElementById('chartDividas'), {
        type: 'pie',
        data: {
          labels: Object.keys(divTipo),
          datasets: [{ data: Object.values(divTipo), backgroundColor: ['#dc2626','#ef4444','#f87171','#fca5a5'] }]
        }
      });
    }

    const evolucao = [];
    for (let i = 5; i >= 0; i--) {
      const d = new Date(new Date().getFullYear(), new Date().getMonth() - i, 1);
      const mId = getMonthId(d);
      const txMes = JSON.parse(localStorage.getItem(`gf_erp_tx_${mId}`) || '[]');
      const rMes = calcularResumo(txMes);
      evolucao.push({
        label: d.toLocaleDateString('pt-BR', { month: 'short' }),
        renda: rMes.renda, despesas: rMes.essenciais + rMes.livres, poupanca: rMes.poupanca, dividas: rMes.dividas
      });
    }

    new Chart(document.getElementById('chartEvolucao'), {
      type: 'line',
      data: {
        labels: evolucao.map(m => m.label),
        datasets: [
          { label: 'Receitas', data: evolucao.map(m => m.renda), borderColor: cores.receita },
          { label: 'Despesas', data: evolucao.map(m => m.despesas), borderColor: cores.essenciais },
          { label: 'PoupanÃ§a', data: evolucao.map(m => m.poupanca), borderColor: cores.poupanca },
          { label: 'DÃ­vidas', data: evolucao.map(m => m.dividas), borderColor: cores.dividas, borderDash: [5,5] }
        ]
      }
    });

    const tbody = document.getElementById('tbodyLancamentos');
    if (tx.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum lanÃ§amento</td></tr>';
    } else {
      tx.sort((a, b) => b.data.localeCompare(a.data)).forEach(t => {
        let tipo = t.tipo.toUpperCase();
        if (t.tipo === 'despesa') tipo = t.subtipo === 'essencial' ? 'ESSENCIAL' : 'LIVRE';
        tbody.innerHTML += `<tr><td>${new Date(t.data).toLocaleDateString('pt-BR')}</td><td>${tipo}</td><td>${t.categoria}</td><td>${brl(t.valor)}</td></tr>`;
      });
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm("Sair?")) { localStorage.setItem(LOGGED_KEY, "false"); window.location.href = "index.html"; }
    });
  </script>

  <style>
    @media print {
      .no-print { display: none !important; }
      .kpi--dividas { border: 2px solid #dc2626 !important; }
    }
  </style>
</body>
</html>
